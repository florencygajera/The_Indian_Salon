{% extends "base.html" %}
{% block title %}Book Appointment | {{ salon.name }}{% endblock %}

{% block content %}
<div class="hero-mini">
<div class="kicker">Booking</div>
<h2 class="h2">Book an Appointment</h2>
<p class="p">Select service → choose date → pick a slot → confirm.</p>
</div>

<div class="split">
<!-- Form -->
<div class="card">
    <h3>Your Details</h3>

    <div class="form-grid">
    <div>
        <label class="lbl">Full Name</label>
        <input class="inp" id="name" placeholder="Enter your name" />
    </div>

    <div>
        <label class="lbl">Phone</label>
        <input class="inp" id="phone" placeholder="e.g. 9876543210" />
    </div>

    <div>
        <label class="lbl">Email (optional)</label>
        <input class="inp" id="email" placeholder="you@gmail.com" />
    </div>
    
    <div>
        <label class="lbl">Service</label>
        <div class="selectWrap">
            <select class="inp select" id="service">
            <option value="">Loading services...</option>
            </select>
            <span class="selectArrow">▾</span>
            </div>
            </div>

    <div>
        <label class="lbl">Date</label>
        <input class="inp" id="date" type="date" />
    </div>
    
    <div>
        <label class="lbl">Notes (optional)</label>
        <input class="inp" id="notes" placeholder="Any preference..." />
    </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
    <button class="btn btn--primary" id="loadSlotsBtn" type="button">Load Slots</button>
    <button class="btn btn--outline" id="clearBtn" type="button">Clear</button>
    </div>

    <div id="msg" class="msg" style="display:none"></div>
</div>

<!-- Slots -->
<div class="card" id="slotsCard" style="display:none;">
    <h3>Available Slots</h3>
    <p class="p" style="margin-top:6px">Tap a slot to select it.</p>

    <div id="slots" class="slots"></div>

    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn btn--dark" id="confirmBtn" type="button" disabled>Confirm Booking</button>
        <a class="btn btn--outline" target="_blank"
            href="https://wa.me/{{ salon.phone | replace('+','') | replace(' ','') }}">WhatsApp</a>
    </div>
</div>
</div>

<div class="section">
    <div class="card">
        <h3>Need help?</h3>
        <p class="p">Call us at <b>{{ salon.phone }}</b> or WhatsApp for quick booking.</p>
    </div>
</div>

<script>
    const el = (id) => document.getElementById(id);

        const msgBox = el("msg");
        const slotsWrap = el("slots");
        const confirmBtn = el("confirmBtn");
                    const slotsCard = el("slotsCard");

                    let selectedSlotKey = null; // `${starts_at}|${ends_at}`
                    let selectedSlotObj = null; // slot object
                    let slotPoll = null;
                    let lastSlotQuery = null;   // { date, serviceId }

        function showMsg(text, type = "info") {
            msgBox.style.display = "block";
            msgBox.className = "msg " + type;
            msgBox.textContent = text;
        }

        function clearMsg() {
            msgBox.style.display = "none";
            msgBox.textContent = "";
        }

                    function stopPolling() {
                        if (slotPoll) clearInterval(slotPoll);
                        slotPoll = null;
                    }

        function setTodayDefault() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            el("date").value = `${yyyy}-${mm}-${dd}`;
            el("date").min = `${yyyy}-${mm}-${dd}`;
        }

        async function loadServices() {
            try {
            const r = await fetch("/api/services");
            const data = await r.json();
                const services = Array.isArray(data) ? data : [];

            const s = el("service");
            s.innerHTML = "";

                const opt0 = document.createElement("option");
                opt0.value = "";
                opt0.textContent = "Select a service";
                s.appendChild(opt0);

                if (!services.length) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No services found (add via API/admin)";
                s.appendChild(opt);
                return;
            }

                services.forEach((x) => {
                const opt = document.createElement("option");
                opt.value = x.id;
                opt.textContent = `${x.category} • ${x.name} (${x.duration_minutes} min)`;
                s.appendChild(opt);
            });
                                            } catch (e) {
                                                showMsg("Failed to load services. Check /api/services.", "err");
                                            }
                                        }

                                        function slotKey(s) {
                                            return `${s.starts_at}|${s.ends_at}`;
        }

                    function renderSlots(slots) {
            slotsWrap.innerHTML = "";

            if (!slots || !slots.length) {
                selectedSlotKey = null;
                selectedSlotObj = null;
                confirmBtn.disabled = true;
                slotsWrap.innerHTML = `<div class="muted">No slots available for selected date/service.</div>`;
                return;
            }

                    let stillSelected = false;

            slots.forEach((s) => {
                const btn = document.createElement("button");
                btn.type = "button";

      const startTxt = new Date(s.starts_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                const endTxt = new Date(s.ends_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      const remaining = (s.remaining_capacity ?? null);
      const label = remaining === null ? "" : ` • ${remaining} left`;

                const k = slotKey(s);
                const isFull = !!s.is_full;

                btn.className = "slot" + (isFull ? " slot--full" : "");

                // keep active selection after refresh
                if (selectedSlotKey && k === selectedSlotKey && !isFull) {
                    btn.classList.add("slot--active");
                    stillSelected = true;
                }

      btn.textContent = `${startTxt} - ${endTxt}${label}`;

                if (isFull) {
                    btn.disabled = true;
                    slotsWrap.appendChild(btn);
                    return;
      }

      btn.addEventListener("click", () => {
          document.querySelectorAll(".slot").forEach(x => x.classList.remove("slot--active"));
          btn.classList.add("slot--active");
          selectedSlotKey = k;
          selectedSlotObj = s;
          confirmBtn.disabled = false;
          clearMsg();
      });

      slotsWrap.appendChild(btn);
            });

                    // if previously selected slot became full/disappeared
                    if (selectedSlotKey && !stillSelected) {
                        selectedSlotKey = null;
                        selectedSlotObj = null;
                        confirmBtn.disabled = true;
                        showMsg("Slot became unavailable. Please pick another slot.", "warn");
                    } else if (stillSelected) {
                        confirmBtn.disabled = false;
                    } else {
                        confirmBtn.disabled = true;
                    }
        }

                    async function refreshSlots() {
                        if (!lastSlotQuery?.date || !lastSlotQuery?.serviceId) return;

                                        const url = `/api/bookings/slots?date=${encodeURIComponent(lastSlotQuery.date)}&service_id=${encodeURIComponent(lastSlotQuery.serviceId)}`;
                                        const r = await fetch(url);
                                        const data = await r.json();
                                        renderSlots(data);
                                    }
                                    async function loadServices() {
                                        try {
                                            const r = await fetch("/api/services");
                                            const data = await r.json();
                                            servicesCache = Array.isArray(data) ? data : [];

                                    const s = el("service");
                                    s.innerHTML = "";

                                    const opt0 = document.createElement("option");
                                    opt0.value = "";
                                    opt0.textContent = "Select a service";
                                    s.appendChild(opt0);

                                    if (!servicesCache.length) return;

                                    // group by category
                                    const groups = {};
                                    servicesCache.forEach(x => {
                                        const cat = (x.category || "Other").trim();
                                        if (!groups[cat]) groups[cat] = [];
                                        groups[cat].push(x);
                                    });

                                    // render category optgroups
                                    Object.keys(groups).sort().forEach(cat => {
                                        const og = document.createElement("optgroup");
                                        og.label = cat;

                                groups[cat]
                                    .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
                                    .forEach(x => {
                                        const opt = document.createElement("option");
                                        opt.value = x.id;
                                        opt.textContent = `${x.name} (${x.duration_minutes} min)`;
                                        og.appendChild(opt);
                                    });

                                s.appendChild(og);
                            });
                                } catch (e) {
                                    showMsg("Failed to load services. Check /api/services.", "err");
                                }
                            }
        async function confirmBooking() {
            clearMsg();

            const name = el("name").value.trim();
            const phone = el("phone").value.trim();
            const email = el("email").value.trim();
            const notes = el("notes").value.trim();
            const serviceId = el("service").value;

            if (!name) return showMsg("Please enter your name.", "warn");
            if (!phone) return showMsg("Please enter your phone number.", "warn");
            if (!serviceId) return showMsg("Please select a service.", "warn");
            if (!selectedSlotObj) return showMsg("Please select a slot.", "warn");

            const payload = {
                customer_name: name,
                customer_phone: phone,
                customer_email: email ? email : null,
                service_id: Number(serviceId),
                staff_id: null,
                starts_at: selectedSlotObj.starts_at,
                ends_at: selectedSlotObj.ends_at,
                notes: notes ? notes : null
            };

            showMsg("Creating booking...", "info");

            const r = await fetch("/api/bookings/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await r.json();

            if (!r.ok) {
                const detail = data?.detail || "Booking failed.";
                showMsg(detail, "err");
                await refreshSlots(); // update full counts instantly
                return;
            }

            showMsg("✅ Booking received! We will confirm shortly.", "ok");

            // clear selection + refresh
            selectedSlotKey = null;
            selectedSlotObj = null;
            confirmBtn.disabled = true;
            document.querySelectorAll(".slot").forEach(x => x.classList.remove("slot--active"));

            await refreshSlots();
        }

        function clearAll() {
            el("name").value = "";
            el("phone").value = "";
            el("email").value = "";
            el("notes").value = "";
            el("service").value = "";

            slotsWrap.innerHTML = "";
            slotsCard.style.display = "none";

            selectedSlotKey = null;
            selectedSlotObj = null;
            confirmBtn.disabled = true;

            clearMsg();
            setTodayDefault();
            stopPolling();
            lastSlotQuery = null;
        }

        el("loadSlotsBtn").addEventListener("click", loadSlots);
        el("confirmBtn").addEventListener("click", confirmBooking);
        el("clearBtn").addEventListener("click", clearAll);

        // init
        setTodayDefault();
                    loadServices();
</script>
{% endblock %}
